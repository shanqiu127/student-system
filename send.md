# 注册邮箱验证功能需求文档

## 1. 背景与目标

- 只支持 QQ 邮箱和网易邮箱作为发件邮箱。
- 通过发送一次性验证码并校验，确保注册邮箱真实有效，降低恶意注册与垃圾账号比例。

---

## 2. 整体业务流程

1. 在注册页面增加邮箱输入和验证的功能。
2. 用户填写邮箱信息，用户点击「获取验证码」按钮，请求后端发送验证码接口。
3. 后端校验邮箱格式、是否已注册、是否触发频率限制。
4. 通过校验后：
   - 生成 6 位数字验证码；
   - 将验证码与邮箱、过期时间等存入数据库；
   - 通过 QQ/网易 SMTP 将验证码发送到该邮箱。
5. 用户在前端输入收到的验证码，调用后端校验接口。
6. 后端验证验证码：
   - 验证码是否存在、是否匹配、是否过期、错误次数是否超限。
7. 验证通过后，标记该邮箱为「已验证」，允许继续完成注册并创建用户。
8. 允许重新发送验证码，但是错误次数超过5次就禁止。

---

## 3. 功能性需求

### 3.1 邮箱格式和唯一性校验

- 使用正则表达式进行邮箱格式校验，兼容常见邮箱格式。示例：
  - 支持 `@qq.com`、 QQ 邮箱；
  - 支持 `@163.com`网易邮箱；
  - 限制收件人邮箱域名，现在只对应@qq.com和@163.com。
- 邮箱输入统一做以下预处理：
  - 去除前后空格；
  - 全部转为小写存储与对比。
  -只能选择两类邮箱，然后输入前缀，再选择邮箱类型
- 校验邮箱是否已在用户表中存在：
  - 已注册：返回「该邮箱已注册」错误码与提示文案。

### 3.2 验证码生成与存储

- 验证码规则：
  - 长度：6 位纯数字（例如 `000000`–`999999`），支持通过配置修改长度；
  - 随机生成，避免简单可猜测模式。
- 验证码有效期：
  - 默认 5 分钟，可通过配置项调整；
  - 过期后验证失败，提示用户重新获取验证码。
- 存储位置：
    本地生产：Mysql
    开发环境：H2
- 存储字段示例（以 Redis Hash 或 DB 表字段形式）：
  - `email`：邮箱地址；
  - `code`：验证码；
  - `scene`：业务场景（ `register`、`reset_password`)；
  - `expireAt`：过期时间戳；
  - `tryCount`：当前验证码已尝试验证的次数；
  - `verified`：是否已通过验证（布尔或状态码）。
- 安全要求：
  - 同一邮箱在有效期内仅保持一条最新验证码记录，生成新验证码时覆盖旧记录。

### 3.3 邮件发送（QQ 邮箱 / 网易邮箱）

- 使用 Spring Mail（`spring-boot-starter-mail`）进行邮件发送。
- 支持配置以下 SMTP 账号为发件人：
  - QQ 邮箱：`smtp.qq.com`，端口 465（SSL）；
  - 网易邮箱：`smtp.163.com` ，端口 465（SSL）；
  - 通过修改配置可切换不同发件邮箱。
- Spring 配置项：
  - qq邮箱
  - `spring.mail.host`：smtp.qq.com
  - `spring.mail.port`：465
  - `spring.mail.username`：3148338348@qq.com
  - `spring.mail.password`：kcowjkvmhsiiddgj
  - `spring.mail.properties.mail.smtp.auth=true`；
  - `spring.mail.properties.mail.smtp.starttls.enable=true` 
  - `mail.from.name`：nihao
  
  -网易邮箱
    - `spring.mail.host`：smtp.163.com
  - `spring.mail.port`：465
  - `spring.mail.username`：m18378174947@163.com
  - `spring.mail.password`：ARacm362H6iReGek
  - `spring.mail.properties.mail.smtp.auth=true`；
  - `spring.mail.properties.mail.smtp.starttls.enable=true` 
  - `mail.from.name`：nihao
- 邮件内容需求：
  - 标题格式：`【学生信息管理系统】邮箱验证码`；
  - 正文需包含：
    - 验证码内容（高亮或加粗显示，如：`您的验证码为：123456`）；
    - 有效期提示（如「有效期 5 分钟」）；
    - 安全提示（如「请勿将验证码泄露给他人」）；
- 发送结果处理：
  - 发送成功：记录发送日志（邮箱、时间、发件账号、结果等）。
  - 发送失败：
    - 捕获异常，记录详细错误日志；
    - 返回前端统一错误信息（如「邮件发送失败，请稍后再试」），不暴露内部错误详情。

### 3.4 验证码校验逻辑

- 输入参数：
  - `email`：用户邮箱；
  - `code`：验证码；
- 校验步骤：
  1. 从 Redis/DB 获取当前邮箱在该场景下的最新验证码记录；
  2. 如果无记录或记录已过期：返回「验证码已失效或不存在」；
  3. 对比用户输入的验证码与存储的验证码：
     - 不匹配：错误次数 +1；
       - 若错误次数 < 最大尝试次数（ 5 次），返回「验证码错误」；
       - 若错误次数 ≥ 最大尝试次数，标记该验证码失效，要求用户重新获取验证码；
  4. 校验通过：
     - 标记该邮箱当前场景为已验证（可以写入单独的标志，或在用户注册时直接信任当前请求）；
     - 可删除验证码记录或更新状态为已使用。

### 3.5 频率限制与防刷

- 发送频率限制：
  - 同一邮箱：
    - 两次发送之间最少间隔 60 秒；
    - 同一邮箱每天发送上限（ 10 次）。
- 验证尝试次数限制：
  - 同一验证码的最大错误次数， 5 次；
  - 达到上限后，该验证码作废，需要重新发送。
- 防盗刷
  - 提醒用户完成用户名和密码和确认密码和验证码输入才可允许发送验证码
---



## 4. 前端交互需求（概要）

- 页面元素：
  - 邮箱输入框；
  - 「获取验证码」按钮；
  - 验证码输入框；
- 「获取验证码」按钮行为：
  - 点击后立即禁用，并开始倒计时显示（如「60 秒后可重新获取」）；
  - 倒计时结束后恢复为可点击状态。
- 前端提示文案示例：
  - 发送成功：`验证码已发送到您的邮箱，请在 5 分钟内完成验证`；
  - 发送失败：`验证码发送失败，请稍后重试`；
  - 格式错误：`邮箱格式不正确`；
  - 已注册：`该邮箱已注册`；
  - 验证码错误：`验证码错误，请重新输入`；
  - 验证码过期：`验证码已过期，请重新获取`；
  - 频率限制：`操作过于频繁，请稍后再试`。
- 用户指引：
  - 提示用户检查垃圾邮件文件夹；
  - 若长时间未收到邮件，允许点击「重新发送验证码」。

---

## 6. 后端接口设计

> 仅为接口说明，用于开发对齐，不限定具体实现细节,

### 6.1 发送邮箱验证码接口

- URL：`POST /api/auth/email/code/send`
- 功能：向指定邮箱发送注册场景验证码。
- 请求体（JSON 示例）：
  - `email`：`String`，必填，用户邮箱；
- 返回：
  - 成功：`{"code":0,"message":"验证码已发送"}`；
  - 失败：
    - 邮箱格式错误：`code = 1001`；
    - 邮箱已注册：`code = 1002`；
    - 频率限制：`code = 1003`；
    - 邮件服务异常：`code = 1500` 。

### 6.2 校验邮箱验证码接口

- URL：`POST /api/auth/email/code/verify`
- 功能：校验用户输入的验证码是否正确且有效。
- 请求体（JSON 示例）：
  - `email`：`String`，必填；
  - `code`：`String`，必填；
- 返回：
  - 成功：`{"code":0,"message":"验证通过"}`；
  - 失败：
    - 验证码错误：`code = 2001`；
    - 验证码过期/不存在：`code = 2002`；
    - 错误次数超限：`code = 2003`。



---
## 7. 数据库设计建议

###  数据库表方案（持久记录）

- 表名：`email_verification_code`
- 字段示例：
  - `id`（主键）
  - `email`（唯一约束可视需求设置）
  - `code`
  - `scene`
  - `expire_time`
  - `try_count`
  - `status`（0=未使用，1=已通过，2=失效/已过期）
  - `created_time`
  - `updated_time`

---


---

> 本文档用于指导基于 Java Spring/Spring Boot 实现的注册邮箱验证功能开发。如果后续需要，我可以再为你补充具体的 `Controller`、`Service` 接口示例代码和 `application.yml` 配置示例。
